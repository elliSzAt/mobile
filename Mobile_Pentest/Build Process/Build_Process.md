# Android Build Process

 - Tên tài liệu: Mobile Application Security and Penetration Testing v 2.5
 - Thực hiện: Trọng
 - Cập nhật lần cuối: 07/10/2024

 # Table of Contents

  - [Compiling Process](#Compiling_Process)
  - [APK Structure](#APK_Structure)
  - [Code Signing](#Code_Signing)

1. [Compiling Process](#Compiling_Process)

Quá trình compiling android app bao gồm rất nhiều bước. Trước khi đi vào các bước cụ thể, mình sẽ tham khảo sơ đồ tóm gọn các bước trong quá trình compiling android app dưới đây.

![alt text](android_build_process_1.png)

<a name="AAPT Tool">AAPT Tool</a>

``AAPT`` là viết tắt của ``android assets pakaging tool``, là một công cụ trong Android SDK được sử dụng để biên dịch và đóng gói các tài nguyên cho ứng dụng Android.

 - Biên dịch tài nguyên: AAPT chuyển đổi các tài nguyên XML (như ``strings.xml``, ``colors.xml``, ``styles.xml``) thành định dạng nhị phân có thể sử dụng trong ứng dụng.
 - Tạo file ``R.java``: AAPT tạo ra tệp ``R.java``, chứa các ID tham chiếu đến các tài nguyên của ứng dụng. Điều này cho phép lập trình viên truy cập các tài nguyên (như chuỗi văn bản, hình ảnh) từ mã Java.

<a name="Android Build Process Steps">Android Build Process Steps</a>

 - ``AAPT`` lấy tất cả các tài nguyên có trong thư mục ``res/`` và ``AndroidManifest.xml`` (metadata của android app) và biên dịch chúng. Sau đó tạo ra một class ``R.java`` có tất cả các id tài nguyên.

 ```
 $ aapt
Android Asset Packaging Tool

Usage:
 aapt l[ist] [-v] [-a] file.{zip,jar,apk}
   List contents of Zip-compatible archive.

 aapt d[ump] [--values] [--include-meta-data] WHAT file.{apk} [asset [asset ...]]
   strings          Print the contents of the resource table string pool in the APK.
   badging          Print the label and icon for the app declared in APK.
   permissions      Print the permissions from the APK.
   resources        Print the resource table from the APK.
   configurations   Print the configurations in the APK.
   xmltree          Print the compiled xmls in the given assets.
   xmlstrings       Print the strings of the given compiled xml assets.

 aapt p[ackage] [-d][-f][-m][-u][-v][-x][-z][-M AndroidManifest.xml] \
        [-0 extension [-0 extension ...]] [-g tolerance] [-j jarfile] \
        [--debug-mode] [--min-sdk-version VAL] [--target-sdk-version VAL] \
        [--app-version VAL] [--app-version-name TEXT] [--custom-package VAL] \
        [--rename-manifest-package PACKAGE] \
        [--rename-instrumentation-target-package PACKAGE] \
        [--utf16] [--auto-add-overlay] \
        [--max-res-version VAL] \
        [-I base-package [-I base-package ...]] \
        [-A asset-source-dir]  [-G class-list-file] [-P public-definitions-file] \
        [-S resource-sources [-S resource-sources ...]] \
        [-F apk-file] [-J R-file-dir] \
        [--product product1,product2,...] \
        [-c CONFIGS] [--preferred-configurations CONFIGS] \
        [--split CONFIGS [--split CONFIGS]] \
        [--feature-of package [--feature-after package]] \
        [raw-files-dir [raw-files-dir] ...] \
        [--output-text-symbols DIR]
```

 - Sau đó tất cả các file java bao gồm ``R.java`` sẽ được biên dịch hết về dạng bytecode.
 - Để ứng dụng chạy trên dalvik VM thì bytecode sẽ được biên dịch sang Dalvik byte code (``.dex`` files).
 - Tiếp theo file ``.dex`` và các tài nguyên sẽ được biên dịch cùng nhau để tạo thành ``.apk`` file.
 - Cuối cùng để tạo được một file .apk hoàn chỉnh có thể sử dụng được, ta cần cung cấp cho nó một chữ ký.

![alt text](android_build_process_2.png)

2. [APK Structure](#APK_Structure)

Các app android tất cả đều được đóng gói trong một file ``.apk``, thực chất nó chỉ là một file ``zip``. Nếu sửa đổi đuôi file thì ta có thể trích xuất được nội dung của nó.

![alt text](image.png)

Tiếp theo mình sẽ đi đến các phần nội dung có trong một file ``.apk``. Các nội dung này là cần thiết khi khởi chạy android app, bao gồm:

 - ``AndroidManifest.xml`` - file cần thiết để mô tả về ứng dụng. File manifest chứa các thông tin chính về các thành phần của ứng dụng như:

    - Các pakage name của ứng dụng.
    - Các thành phần của ứng dụng chẳng hạn như activities hay resources.
    - Các quyền cần thiết mà ứng dụng yêu cầu khi chạy ứng dụng và các quyền cần thiết khi truy cập vào thông tin của ứng dụng từ các ứng dụng khác.
    - Các thông tin khác chẳng hạn như phiên bản android yêu cầu tối thiểu hay các thiết bị được hỗ trợ.

![alt text](image-1.png)

 - ``assets`` - chúng ta có thể kiểm soát các loại tài nguyên của ứng dụng bằng cách phân cấp thư mục, tạo ra các thư mục riêng cho từng thành phần. Nếu ứng dụng có thể hiển thị videos hay sử dụng các template thì sẽ được chứa trong thư mục này. Ngoài ra một số frameworks còn sử dụng thư mục này để lưu trữ code hay dữ liệu.

    - Các ứng dụng ``Cordova`` hay ``React-native`` lưu trữ code js trong thư mục assets.
    - Ứng dụng Maui, Xamarin lưu trữ file ``.dll`` trong thư mục ``assemblies`` (hoạt động tương tự như ``assets``).

 - ``classes.dex`` - đây là các classes java được biên dịch thành ``dex`` file để chạy trên thiết bị. Mặc dù ``dex`` file bắt nguồn từ Dalvik VM tuy nhiên nó có thể được sử dụng cho cả ART.

 - ``libs`` - là thư mục chứa các native libraries (mã máy), chứa các thư mục con phục vụ cho riêng từng bộ xử lý. Việc các thư mục con có xuất hiện hay không đại diện cho nền tảng đó có được hỗ trợ hay không. Ví dụ: nếu có thư mục con x86_64, ứng dụng sẽ tương thích với trình giả lập Android. Appdome’s Binary Code Obfuscation sẽ mã hóa các tệp này để bảo vệ chúng khỏi kỹ thuật đảo ngược.

    - ``armeabi-v7a`` – Binaries supporting ARMv7.
    - ``arm64-v8a`` – Binaries supporting ARMv8.
    - ``x86`` – Binaries supporting x86.
    - ``x86_64`` – Binaries supporting x86-64.
    - ``mips`` – Binaries for MIPS, deprecated since ndkr17.

 - ``META-INF`` - Thư mục này chứa thông tin xác minh và được tạo khi ``signing`` ứng dụng. Căn bản đây giống như cccd dành cho file apk, khi thay đổi bất cứ điều gì trong ứng dụng ta đều phải ``resigning``. Nếu không OS sẽ từ chối cài đặt. Nội dung của thư mục này bao gồm:

    - ``CERT.SF`` - Danh sách tất cả các tệp có hàm băm SHA-1 của chúng.
    - ``CERT.RSA`` - Chứa nội dung đã ký của ``CERT.SF`` và được dùng để xác minh tính toàn vẹn của ứng dụng bằng khóa chung.
    - ``MANIFEST.MF`` - Chứa SHA-256-Digest của tất cả các tệp trong gói ứng dụng. Nó được sử dụng để xác minh tính hợp lệ của từng tệp trong zip, đảm bảo rằng việc thay đổi tệp này hoặc bất kỳ tệp nào khác trong vùng chứa zip sẽ thu hồi chữ ký và làm cho nó không hợp lệ.

 - ``res`` - Đây là thư mục chứa tài nguyên như ``colors``, ``layout``,... -- ví dụ: hình ảnh chưa được biên dịch vào trong ``resources.arsc``.
 - ``resources.arsc`` - Một tệp chứa thông tin liên kết giữa ``class.dex`` và ``res``. Ví dụ đoạn code sẽ tham chiếu một đoạn text của ``dialog``, khi mà ``resources`` chứa đoạn text đó ở mọi ngôn ngữ thì OS Android sẽ chọn ngôn ngữ chính xác theo cấu hình ngôn ngữ của thiết bị.

3. [Code Signing](#Code_Signing)

Như đã nói khi cài đặt một ứng dụng android thì đòi hỏi ứng dụng đó phải có chữ ký số ``signing``. Hoặc khi ta patch lại một ứng dụng gì đó thì phải thực hiện việc tạo ra một chữ ký số mới và tiến hành ``resiging`` cho ứng dụng thì khi đó mới có thể cài đặt và chạy được.

![alt text](apk-validation-process.png)

Android sử dụng thứ gọi là ``certificate`` và ``keystore``. Public-key certificate, được biết đến như là ``digital certificate`` hay ``identity certificate`` chứa một cặp ``publickey/privatekey``, cũng như một số siêu dữ liệu khác xác định chủ sở hữu khóa (ví dụ: tên và địa chỉ). Chủ sở hữu chứng chỉ giữ khóa riêng tương ứng.

Khi signing một ứng dụng, công cụ dụng để signing sẽ đính một public-key certificate cho file apk. The public-key certificate đóng vai trò như một dấu hiệu nhận dạng giữa mình và file apk và privatekey tương ứng của nó. Điều này giúp Android đảm bảo rằng mọi bản cập nhật trong tương lai cho APK của bạn đều xác thực và đến từ tác giả. Khóa dùng để tạo chứng chỉ này được gọi là app signing key.

Keystore là một tệp nhị phân chứa một hoặc nhiều khóa riêng.

Khi chạy hoặc debug project IDE, Android Studio sẽ tự động ký APK của bạn bằng debug certificate do công cụ SDK Android tạo. Lần đầu tiên chạy hoặc debug project trong Android Studio, IDE sẽ tự động tạo debug Keystore và certificate trong $HOME/.android/debug.

<a name="keytool">keytool</a>

Để signing được ứng dụng apk trước hết ta phải tạo được Keystore và dùng nó để signing. Để làm được việc này ở đây mình sử dụng ``keytool``.

```
keytool -genkey -v -keystore harshit_key.keystore -alias harsh_key -keyalg RSA -keysize 2048 -validity 10000
```

Sau khi nhập câu lệnh trên thì mình điền vào các mục như đã được yêu cầu.

![alt text](11.png)

Có thể thấy là bây giờ ``keystore`` được lưu ở dạng self-signed certificate với hiệu lực là 10.000 ngày với RSA 2048 bit key. Tiếp theo ta sẽ dùng nó để ký vào app vừa được patch.

```
jarsigner -verbose -sigalg SHA1withRSA -digestalg SHA1 -keystore harshit_key.keystore new_uncrackable.apk harsh_key
```

![alt text](12.png)